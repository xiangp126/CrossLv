## iptables

### stop firwwalld

```bash
systemctl stop firewalld
systemctl disable firewalld
```

### Install and Start Service
- CentOS 6

```bash
service iptables status
service iptables start
service iptables stop
```

- CentOS 7

[How Can I Use iptables on CentOS 7?](https://stackoverflow.com/questions/24756240/how-can-i-use-iptables-on-centos-7)

```bash
yum install iptables-services

# systemctl status iptables.service
● iptables.service - IPv4 firewall with iptables
   Loaded: loaded (/usr/lib/systemd/system/iptables.service; disabled; vendor preset: disabled)
   Active: inactive (dead)

systemctl enable iptables
systemctl start iptables

# systemctl status iptables.service
● iptables.service - IPv4 firewall with iptables
   Loaded: loaded (/usr/lib/systemd/system/iptables.service; enabled; vendor preset: disabled)
   Active: active (exited) since Sat 2018-09-29 10:10:56 CST; 3min 25s ago
 Main PID: 414035 (code=exited, status=0/SUCCESS)

Sep 29 10:10:56 localhost.localdomain systemd[1]: Starting IPv4 firewall with iptables...
Sep 29 10:10:56 localhost.localdomain iptables.init[414035]: iptables: Applying firewall rules: [  OK  ]
Sep 29 10:10:56 localhost.localdomain systemd[1]: Started IPv4 firewall with iptables.
```

### ~~clear rules~~
```bash
iptables -F
iptables -X
iptables -Z
iptables -t nat -F

# iptables-save
# Generated by iptables-save v1.4.21 on Sat Sep 29 16:46:19 2018
*filter
:INPUT ACCEPT [98:13389]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [77:9459]
COMMIT
# Completed on Sat Sep 29 16:46:19 2018
# Generated by iptables-save v1.4.21 on Sat Sep 29 16:46:19 2018
*nat
:PREROUTING ACCEPT [1:84]
:INPUT ACCEPT [1:84]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
# Completed on Sat Sep 29 16:46:19 2018
```

## NAT
### enable forward
*echo 1 > /proc/sys/net/ipv4/ip_forward*

### iptables-save

```bash
# save current config to iptables.rule
iptables-save > iptables.rule
# vim iptables.rule

# add 2 rule for chain 'nat'
-A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.10.1
-A POSTROUTING -j MASQUERADE
# add 1 rule for chain filter
-A FORWARD -j ACCEPT
```
### iptables.rule
```bash
# Generated by iptables-save v1.4.21 on Sat Sep 29 16:58:04 2018
*nat
:PREROUTING ACCEPT [29:3462]
:INPUT ACCEPT [13:1080]
:OUTPUT ACCEPT [79:5413]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.10.1
# MASQUERADE 作用是从服务器的网卡上，自动获取当前ip地址来做 SNAT
-A POSTROUTING -j MASQUERADE
COMMIT
# Completed on Sat Sep 29 16:58:04 2018
# Generated by iptables-save v1.4.21 on Sat Sep 29 16:58:04 2018
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [705:242169]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j ACCEPT
# -A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Sat Sep 29 16:58:04 2018
```

### iptables-restore
```bash
# restore rule, temporary and immediately
iptables-restore < iptables.rule
# save the configuration permanently
/etc/init.d/iptables save

# iptables -L -n -t nat
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:192.168.10.1

Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0
```

## Debug
```bash
$ curl 10.2.10.177
curl: (7) Failed connect to 10.2.10.177:80; No route to host
```

1. check if iptables blocked the **80** port
2. double check `FORWARD ` of chain `filter` was `ACCEPT`

> -A FORWARD -j ACCEPT &radic;<br>
~~-A FORWARD -j REJECT --reject-with icmp-host-prohibited~~